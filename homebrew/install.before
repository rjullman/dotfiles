#!/usr/bin/env bash

# finds things in the given list that are not in the excluded list
#
# this will ignore duplicate entries, ignore leading whitspace, and
# only compare the first word on each line
diff() {
  local list=$1 excluded=$2

  trimmed_diff="$(comm -23 \
      <(echo "$list"     | sed 's/^ *//g' | cut -d' ' -f1 | sort | uniq) \
      <(echo "$excluded" | sed 's/^ *//g' | cut -d' ' -f1 | sort | uniq))"

  while read -r line; do
    echo "$list" | grep -m 1 "$line"
  done < <(echo "$trimmed_diff" | sed '/^$/d')
}

# runs given command once for each arg in args
run_cmd() {
  local cmd=$1 args=$2

  while read -r arg; do
    if ! $cmd $arg; then
      fail "$cmd $arg"
    fi
  done < <(echo "$args" | sed '/^$/d')
}

run_cmds() {
  local install_cmd=$1 uninstall_cmd=$2 list_cmd=$3 args=$4

  list=`$list_cmd`

  # install all expected items not found in list
  to_install="$(diff "$args" "$list")"
  run_cmd "$install_cmd" "$to_install"

  # remove all unexpected items found in list
  to_uninstall="$(diff "$list" "$args")"
  run_cmd "$uninstall_cmd" "$to_uninstall"
}

# returns all given brews and their dependencies
brew_deps() {
  brews=$1
  echo "$brews"
  echo "$brews" | sed 's/^ *//g' | cut -d' ' -f1 | xargs brew deps --union
}

# install homebrew
if test ! $(which brew)
then
  ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  success "homebrew installed"
fi

# ensure latest homebrew and updated formulae
brew update > /tmp/dot-brew-update

TAPS=$(cat << 'EOF'
  caskroom/cask
  caskroom/drivers
  caskroom/versions
  homebrew/core
  homebrew/dupes
  homebrew/versions
  neovim/neovim
EOF)

BREWS=$(cat << 'EOF'
  awscli
  coreutils
  ffmpeg
  findutils --with-default-names
  gawk
  git
  gradle
  gnu-indent --with-default-names
  gnu-sed --with-default-names
  gnu-tar --with-default-names
  gnu-which --with-default-names
  gnutls
  grep --with-default-names
  groovy
  gzip
  htop
  jq
  less
  neovim
  node
  python
  python3
  reattach-to-user-namespace
  tmux
  unzip
  watch
  wget
  zsh
EOF)

CASKS=$(cat << EOF
  alfred
  docker
  dropbox
  flux
  gimp
  google-chrome
  hammerspoon
  iterm2
  java
  spotify
EOF)

hostname=$(hostname)
if [ "$hostname" = "flounder.local" ]; then

BREWS=$(cat << EOF
  $BREWS
  kubectrl
EOF)

CASKS=$(cat << EOF
  $CASKS
  caffeine
  discord
  google-cloud-sdk
  league-of-legends
  sage
  slack
  sonos
  steam
EOF)

fi

# setup taps
run_cmds 'brew tap' 'brew untap' 'brew tap' "$TAPS"

# install brews
run_cmds 'brew install' 'brew uninstall --force --ignore-dependencies' 'brew list' "$(brew_deps "$BREWS")"

# install casks
run_cmds 'brew cask install' 'brew cask uninstall' 'brew cask list' "$CASKS"
